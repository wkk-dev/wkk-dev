name: Sync Blog Content

on:
  # 触发条件：可以手动运行，也可以设置为定时任务 (例如每天凌晨)
  workflow_dispatch: # 允许手动点击按钮运行
  # schedule:
  #   - cron: '0 0 * * *' # 如果需要自动运行，取消此行注释

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须拥有写入权限才能推送代码

    steps:
      # 1. 检出目标仓库代码
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: wkk-dev/wkk-dev
          token: ${{ secrets.GITHUB_TOKEN }}
          path: target-repo # 将代码检出于子目录，避免污染根目录

      # 2. 下载压缩文件
      - name: Download Compressed File
        run: |
          cd target-repo
          echo "Downloading file..."
          curl -L -o content.gz "https://img.wkr-dev.top/file/blog/IvGRyNIT.gz"
          
          # 验证文件是否存在且不为空
          if [ ! -s content.gz ]; then
            echo "Error: Download failed or file is empty."
            exit 1
          fi
          echo "Download successful."

      # 3. 解压文件
      - name: Extract Compressed File
        run: |
          cd target-repo
          echo "Extracting content.gz..."
          # 假设 .gz 里面是一个 tar 包或者直接是文件，这里处理通用情况
          # 如果是单纯的 .gz (单个文件)，gunzip 会直接解压
          # 如果是 .tar.gz，通常需要 tar -xzf
          # 根据文件名后缀 .gz 判断，先尝试 gunzip，如果失败再尝试 tar
          
          if gzip -t content.gz 2>/dev/null; then
            # 如果是纯 gz 文件 (例如 index.html.gz -> index.html)
            gunzip -k content.gz || true 
            # 如果解压后得到的是 tar 包 (罕见但可能)，继续处理
            if file content | grep -q "POSIX tar"; then
               tar -xf content && rm content
            fi
            rm content.gz
          else
            # 尝试作为 tar.gz 处理 (以防链接实际指向 tar.gz 但后缀写错)
            tar -xzf content.gz || echo "Extraction method unclear, checking file type..."
            rm -f content.gz
          fi
          
          echo "Extraction complete."
          ls -la

      # 4. 配置 Git 用户信息
      - name: Configure Git
        run: |
          cd target-repo
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      # 5. 提交并推送更改
      - name: Commit and Push
        run: |
          cd target-repo
          
          # 添加所有变更
          git add .
          
          # 检查是否有变更需要提交
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          
          # 提交
          git commit -m "chore: auto sync blog content from wkr-dev.top [skip ci]"
          
          # 推送
          git push origin HEAD:main
          # 注意：如果目标仓库的主分支叫 master，请将上面的 main 改为 master
