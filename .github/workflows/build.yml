name: Deploy Hexo Blog to /blog

# 触发条件配置
on:
  # 1. 当向 main 或 master 分支推送代码时自动触发
  push:
    branches:
      - main
      - master
  # 2. 允许在 GitHub Actions 页面手动点击按钮触发
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu 运行环境
    
    # 权限配置：必须授予写入 contents 的权限，以便能推送到另一个仓库
    permissions:
      contents: write

    steps:
      # ==========================================
      # 第一步：检出 Hexo 源码 (当前仓库)
      # ==========================================
      - name: Checkout Hexo Source Code
        uses: actions/checkout@v6
        with:
          submodules: recursive # 递归拉取子模块（如果你的主题是用 git submodule 安装的，这步很重要）
          fetch-depth: 0        # 获取所有历史提交，方便 Hexo 生成正确的日期信息

      # ==========================================
      # 第二步：配置 Node.js 环境 (v24.13.1, 禁用缓存)
      # ==========================================
      - name: Setup Node.js Environment
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '24.13.1' # 精确指定 Node.js 版本
          # cache 配置项已移除，明确禁用缓存以确保每次都是全新安装

      # ==========================================
      # 第三步：安装依赖并构建 Hexo
      # ==========================================
      - name: Install Dependencies and Generate
        run: |
          echo "Installing dependencies (No Cache)..."
          npm install --production # 安装 package.json 中的依赖
          
          echo "Installing Hexo CLI globally..."
          npm install -g hexo-cli  # 全局安装 hexo 命令
          
          echo "Generating static files..."
          hexo clean               # 清理缓存，防止旧文件干扰
          hexo generate            # 执行构建，生成文件到 public 目录
          
          echo "Build complete."

      # ==========================================
      # 第四步：检出目标仓库 (wkk-dev/wkk-dev)
      # ==========================================
      - name: Checkout Target Repository
        uses: actions/checkout@v6
        with:
          repository: wkk-dev/wkk-dev # 目标仓库地址
          token: ${{ secrets.GITHUB_TOKEN }} # 使用自动提供的 GITHUB_TOKEN 进行认证
          path: deploy-target         # 将目标仓库检出于当前目录下的 deploy-target 文件夹
          ref: main                   # 【关键】指定检出目标仓库的 main 分支

      # ==========================================
      # 第五步：同步文件到 /blog 目录
      # ==========================================
      - name: Sync Files to /blog Directory
        run: |
          echo "Preparing /blog directory in target repository..."
          
          # 1. 确保目标仓库中存在 blog 目录
          mkdir -p deploy-target/blog
          
          # 2. 清空 blog 目录下的旧文件
          # 注意：这一步非常重要，确保删除了已废弃的文章或文件，保持同步一致
          rm -rf deploy-target/blog/*
          rm -rf deploy-target/blog/.[!.]* # 删除隐藏文件 (如 .htaccess)，忽略不存在的报错
          
          # 3. 将构建好的 public 目录内容复制到 target/blog
          cp -r public/* deploy-target/blog/
          
          # 单独处理 public 目录下的隐藏文件 (shopt 确保能匹配到)
          shopt -s dotglob nullglob
          for file in public/.*; do
            if [ -e "$file" ]; then
               fname=$(basename "$file")
               if [ "$fname" != "." ] && [ "$fname" != ".." ]; then
                 cp -r "$file" deploy-target/blog/
               fi
            fi
          done

          echo "Files copied. Starting Git commit process..."
          
          # 4. 进入目标仓库目录配置 Git
          cd deploy-target
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # 5. 添加变更
          git add .
          
          # 6. 检查是否有实际变更，如果有则提交并推送
          if ! git diff --staged --quiet; then
            echo "Changes detected. Committing..."
            git commit -m "chore: auto-deploy hexo blog to /blog [skip ci]"
            
            echo "Pushing to remote repository (main branch)..."
            # 【关键】推送到目标仓库的 main 分支
            git push origin HEAD:main
          else
            echo "No changes detected. Skipping commit."
          fi
