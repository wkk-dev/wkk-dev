name: Deploy Hexo from /hexo to /blog

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ==========================================
      # 第一步：检出整个仓库
      # ==========================================
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # 第二步：配置 Node.js (v24.13.1, 禁用缓存)
      # ==========================================
      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '24.13.1'
          # 禁用缓存

      # ==========================================
      # 第三步：进入 /hexo 目录并构建
      # ==========================================
      - name: Install & Build in /hexo
        run: |
          echo "Entering /hexo directory..."
          cd hexo
          
          if [ ! -f "package.json" ]; then
            echo "::error::package.json not found in /hexo directory!"
            exit 1
          fi
          
          echo "Installing dependencies (No Cache)..."
          npm install --production
          
          echo "Installing Hexo CLI..."
          npm install -g hexo-cli
          
          echo "Generating static files..."
          hexo clean
          hexo generate
          
          echo "Build complete."

      # ==========================================
      # 第四步：【关键修改】彻底清空 /blog 并同步新文件
      # ==========================================
      - name: Clean and Sync to /blog
        run: |
          echo "=== Starting Clean and Sync Process ==="
          
          # 1. 确保 blog 目录存在
          mkdir -p blog
          
          # 2. 【核心步骤】彻底清空 blog 目录内容
          echo "Clearing all files in /blog (including hidden files)..."
          
          # 方法 A: 使用 find 命令删除目录内所有文件 (最稳妥，不会误删目录本身)
          # -mindepth 1 表示不删除 blog 目录本身，只删里面的内容
          # -delete 直接删除
          find blog -mindepth 1 -delete
          
          # 验证是否清空
          echo "Files remaining in /blog after clean:"
          ls -la blog || echo "(Directory is empty)"
          
          # 3. 复制新文件
          echo "Copying new files from hexo/public to blog..."
          cp -r hexo/public/* blog/
          
          # 4. 单独处理隐藏文件 (cp -r 有时不会复制以 . 开头的隐藏文件)
          shopt -s dotglob nullglob
          for file in hexo/public/.*; do
            if [ -e "$file" ]; then
               fname=$(basename "$file")
               # 排除当前目录和上级目录引用
               if [ "$fname" != "." ] && [ "$fname" != ".." ]; then
                 cp -r "$file" blog/
               fi
            fi
          done
          
          echo "Sync complete. New files in /blog:"
          ls -la blog

      # ==========================================
      # 第五步：提交并推送到 main 分支
      # ==========================================
      - name: Commit and Push Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          git add .
          
          # 检查是否有变更
          if ! git diff --staged --quiet; then
            echo "Changes detected. Committing..."
            # 提交信息表明进行了清理和重新部署
            git commit -m "chore: clean and redeploy blog from /hexo to /blog [skip ci]"
            
            echo "Pushing to main branch..."
            git push origin HEAD:main
          else
            echo "No changes detected (unlikely if files were cleaned and regenerated). Skipping commit."
          fi
