name: Sync Blog

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v6.0.2
        with:
          repository: wkk-dev/wkk-dev
          token: ${{ secrets.GITHUB_TOKEN }}
          path: target-repo

      - name: Download and Extract
        run: |
          cd target-repo
          curl -L -o content.gz "https://img.wkr-dev.top/file/blog/IvGRyNIT.gz"
          mkdir -p temp_extract
          mv content.gz temp_extract/
          cd temp_extract
          if gzip -t content.gz 2>/dev/null; then
            gunzip -k content.gz
            rm content.gz
            extracted_file=$(ls | head -n 1)
            if [ -n "$extracted_file" ] && file "$extracted_file" | grep -q "POSIX tar"; then
              tar -xf "$extracted_file"
              rm "$extracted_file"
            fi
          else
            tar -xzf content.gz
            rm content.gz
          fi
          shopt -s dotglob
          ls -A | xargs -I {} mv {} ../ || true
          cd ..
          rm -rf temp_extract

      - name: Commit and Push
        run: |
          cd target-repo
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "chore: update root content [skip ci]"
            git push origin HEAD:main
          fi
